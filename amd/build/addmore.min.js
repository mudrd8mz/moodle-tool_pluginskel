define(["jquery"],function(a){var b={deleteElements:function(b,c,d){var e=+a("[name='"+c+"count']").val();if(1!=e){var f;for(var g in b)if(b[g].name==c){f=b[g];break}var h=e-1;a("#id_"+c+" br").filter(":last").remove();for(g in f.values){var i=f.values[g],j="fitem_id_"+c+"_"+h+"_"+i.name;if(a("#"+j).remove(),"array"===i.hint){var k=c+"_"+h+"_"+i.name+"count",l=+a("[name='"+k+"']").val();a("#id_"+c+" br").slice(-(l-1)).remove();for(var m in i.values)for(var n=i.values[m],o=0;l>o;o++){var p=j+"_"+o+"_"+n.name;a("#"+p).remove()}var q="fitem_id_addmore_"+c+"_"+h+"_"+i.name;a("#"+q).remove(),a("[name='"+k+"']").remove()}}a("[name='"+c+"count']").val(e-1)}},addMoreRootElements:function(c,d,e){var f,g=+a("[name='"+d+"count']").val();for(var h in c)if(c[h].name==d){f=c[h];break}var i,j,k,l=g-1,m="<br/>",n=!1;for(h in f.values){var o=f.values[h],p=d+"["+g+"]["+o.name+"]",q="id_"+d+"_"+g+"_"+o.name,r=d+"["+l+"]["+o.name+"]",s="id_"+d+"_"+l+"_"+o.name;if("array"==o.hint){n=!0;var t=a("#fitem_"+s).attr("class");m+='<div id="fitem_'+q+'" class="'+t+'">',m+=a("#fitem_"+s).html(),m+="</div>";for(var u in o.values){var v=o.values[u],w=p+"[0]["+v.name+"]",x=q+"_0_"+v.name,y=r+"[0]["+v.name+"]",z=s+"_0_"+v.name;m+=b.cloneElement(y,z,w,x)}j="id_addmore_"+d+"_"+g+"_"+o.name,k="addmore_"+d+"["+g+"]["+o.name+"]";var A="id_addmore_"+d+"_"+l+"_"+o.name,B="addmore_"+d+"["+l+"]["+o.name+"]";m+=b.cloneElement(B,A,k,j);var C=d+"_"+l+"_"+o.name+"count",D=d+"_"+g+"_"+o.name+"count",E='<input name="'+D+'" value="1" type="hidden"></input>';a('[name="'+C+'"]').after(E)}else m+=b.cloneElement(r,s,p,q)}return a("#fgroup_id_buttons_"+d).before(m),i="id_"+d+"_"+g,b.removeInputFromNewNode(f,i),a("[name='"+d+"count']").val(g+1),n===!0?[[j,k]]:[]},addMoreNestedElements:function(c,d,e){var f=d.substr(0,d.indexOf("["));d=d.substr(d.indexOf("[")+1);var g=d.substr(0,d.indexOf("]"));d=d.substr(d.indexOf("]")+2);var h,i=d.substr(0,d.indexOf("]")),j=f+"["+g+"]["+i+"]",k="id_"+f+"_"+g+"_"+i,l=f+"_"+g+"_"+i+"count",m=+a("[name='"+l+"']").val();for(var n in c)if(c[n].name==f)for(var o in c[n].values)if(c[n].values[o].name==i){h=c[n].values[o];break}var p=m-1,q="<br/>";for(n in h.values){var r=h.values[n],s=j+"["+m+"]["+r.name+"]",t=k+"_"+m+"_"+r.name,u=j+"["+p+"]["+r.name+"]",v=k+"_"+p+"_"+r.name;q+=b.cloneElement(u,v,s,t)}a("#fitem_id_addmore_"+f+"_"+g+"_"+i).before(q);var w=k+"_"+m;b.removeInputFromNewNode(h,w),a("[name='"+l+"']").val(m+1)},removeInputFromNewNode:function(c,d){for(var e in c.values){var f=c.values[e],g=d+"_"+f.name;if(("text"==f.hint||"int"==f.hint)&&a("#"+g).removeAttr("value"),"multiple-options"==f.hint){var h="required"in f&&f.required===!0;h||a("#"+g+' option[value="undefined"]').prop("selected",!0).change()}if("array"==f.hint){var i=g+"_0";b.removeInputFromNewNode(f,i)}}},cloneElement:function(b,c,d,e){for(var f=a("#fitem_"+c).attr("class"),g=a("#fitem_"+c).html();-1!=g.indexOf(c);)g=g.replace(c,e);for(;-1!=g.indexOf(b);)g=g.replace(b,d);var h='<div id="fitem_'+e+'" class="'+f+'">';return h+=g,h+="</div>"},addMore:function(){var c=a.parseJSON(a('[name="templatevars"]').val());a("[name*='addmore_']").on("click",function(){var d=a(this).prop("name").replace("addmore_","");if(-1==d.indexOf("[")){var e=b.addMoreRootElements(c,d,this);if(e.length>0)for(var f in e){var g=e[f][0],h=e[f][1];a("#"+g).on("click",function(){b.addMoreNestedElements(c,h.replace("addmore_",""),this)})}}else b.addMoreNestedElements(c,d,this)}),a("[name*='delete_']").on("click",function(){var d=a(this).prop("name").replace("delete_","");b.deleteElements(c,d,this)})}};return b});