define(["jquery"],function(a){var b={deleteElements:function(b,c,d){var e=parseInt(a("[name='"+c+"count']").val());if(1!=e){var f;for(var g in b)if(b[g].name==c){f=b[g];break}var h=e-1;a("#id_"+c+" br").filter(":last").remove();for(g in f.values){var i=f.values[g],j="fitem_id_"+c+"_"+h+"_"+i.name;if(a("#"+j).remove(),"array"===i.hint){var k=c+"_"+h+"_"+i.name+"count",l=parseInt(a("[name='"+k+"']").val());a("#id_"+c+" br").slice(-(l-1)).remove();for(var m in i.values)for(var n=i.values[m],o=0;l>o;o++){var p=j+"_"+o+"_"+n.name;a("#"+p).remove()}var q="fitem_id_addmore_"+c+"_"+h+"_"+i.name;a("#"+q).remove(),a("[name='"+k+"']").remove()}}a("[name='"+c+"count']").val(e-1)}},addMoreRootElements:function(c,d,e){var f,g=parseInt(a("[name='"+d+"count']").val());for(var h in c)if(c[h].name==d){f=c[h];break}var i,j=g-1,k="<br/>";for(h in f.values){var l=f.values[h],m=d+"["+g+"]["+l.name+"]",n="id_"+d+"_"+g+"_"+l.name,o=d+"["+j+"]["+l.name+"]",p="id_"+d+"_"+j+"_"+l.name;if("array"==l.hint){var q=a("#fitem_"+p).attr("class");k+='<div id="fitem_'+n+'" class="'+q+'">',k+=a("#fitem_"+p).html(),k+="</div>";for(var r in l.values){var s=l.values[r],t=m+"[0]["+s.name+"]",u=n+"_0_"+s.name,v=o+"[0]["+s.name+"]",w=p+"_0_"+s.name;k+=b.cloneElement(v,w,t,u)}var x="id_addmore_"+d+"_"+g+"_"+l.name,y="addmore_"+d+"["+g+"]["+l.name+"]",z="id_addmore_"+d+"_"+j+"_"+l.name,A="addmore_"+d+"["+j+"]["+l.name+"]";k+=b.cloneElement(A,z,y,x);var B=d+"_"+j+"_"+l.name+"count",C=d+"_"+g+"_"+l.name+"count",D='<input name="'+C+'" value="1" type="hidden"></input>';a('[name="'+B+'"]').after(D)}else k+=b.cloneElement(o,p,m,n)}a("#fgroup_id_buttons_"+d).before(k),i="id_"+d+"_"+g,b.removeInputFromNewNode(f,i),a("[name='"+d+"count']").val(g+1)},addMoreNestedElements:function(c,d,e){var f=d.substr(0,d.indexOf("["));d=d.substr(d.indexOf("[")+1);var g=d.substr(0,d.indexOf("]"));d=d.substr(d.indexOf("]")+2);var h,i=d.substr(0,d.indexOf("]")),j=f+"["+g+"]["+i+"]",k="id_"+f+"_"+g+"_"+i,l=f+"_"+g+"_"+i+"count",m=parseInt(a("[name='"+l+"']").val());for(var n in c)if(c[n].name==f)for(var o in c[n].values)if(c[n].values[o].name==i){h=c[n].values[o];break}var p=m-1,q="<br/>";for(n in h.values){var r=h.values[n],s=j+"["+m+"]["+r.name+"]",t=k+"_"+m+"_"+r.name,u=j+"["+p+"]["+r.name+"]",v=k+"_"+p+"_"+r.name;q+=b.cloneElement(u,v,s,t)}a("#fitem_id_addmore_"+f+"_"+g+"_"+i).before(q);var w=k+"_"+m;b.removeInputFromNewNode(h,w),a("[name='"+l+"']").val(m+1)},removeInputFromNewNode:function(c,d){for(var e in c.values){var f=c.values[e],g=d+"_"+f.name;if(("text"==f.hint||"int"==f.hint)&&a("#"+g).removeAttr("value"),"multiple-options"==f.hint){var h="required"in f&&f.required===!0;h||a("#"+g+' option[value="undefined"]').prop("selected",!0).change()}if("array"==f.hint){var i=g+"_0";b.removeInputFromNewNode(f,i)}}},cloneElement:function(b,c,d,e){for(var f=a("#fitem_"+c).attr("class"),g=a("#fitem_"+c).html();-1!=g.indexOf(c);)g=g.replace(c,e);for(;-1!=g.indexOf(b);)g=g.replace(b,d);var h='<div id="fitem_'+e+'" class="'+f+'">';return h+=g,h+="</div>"},addMore:function(){a(".mform").on("click",":button",function(c){var d,e,f=c.target.name;-1!==f.indexOf("addmore_")?(d=a.parseJSON(a('[name="templatevars"]').val()),e=f.replace("addmore_",""),-1==e.indexOf("[")?b.addMoreRootElements(d,e,this):b.addMoreNestedElements(d,e,this)):-1!==f.indexOf("delete_")&&(d=a.parseJSON(a('[name="templatevars"]').val()),e=f.replace("delete_",""),b.deleteElements(d,e,this))})}};return b});